@page "/dashboard/calificar-actividades"
@layout ImpulsaDBA.Client.Components.Layout.DashboardLayout
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@using ImpulsaDBA.Shared.DTOs
@using ImpulsaDBA.Client.Services
@inject AuthenticationStateProvider AuthStateProvider
@inject CalendarioService CalendarioService
@inject AsignaturaService AsignaturaService
@attribute [Microsoft.AspNetCore.Authorization.Authorize]

<PageTitle>Calificar actividades - ImpulsaDBA</PageTitle>

<div class="calificar-page">
    <div class="page-header">
        <div class="page-header-left">
            <h1>Calificar Actividades</h1>
            <p class="page-subtitle">
                Revisa y califica las entregas de los estudiantes para tus actividades con entregable.
            </p>
        </div>
    </div>

    @if (cargando)
    {
        <div class="loading-state">
            <div class="spinner"></div>
            <p>Cargando...</p>
        </div>
    }
    else
    {
        <div class="filtro-grupo">
            <label for="select-grupo-calificar">Filtrar por grupo:</label>
            <select id="select-grupo-calificar" class="select-filtro" @onchange="OnGrupoChange">
                <option value="0">Todos los grupos</option>
                @foreach (var g in gruposUnicos)
                {
                    <option value="@g.IdGrupo" selected="@(idGrupoFiltro == g.IdGrupo)">@g.NombreGrupo</option>
                }
            </select>
        </div>

        <div class="stats-grid">
            <div class="stat-card pending">
                <div class="stat-title">Pendientes</div>
                <div class="stat-value">@TotalPendientes</div>
            </div>
            <div class="stat-card graded">
                <div class="stat-title">Calificadas</div>
                <div class="stat-value">@TotalCalificadas</div>
            </div>
            <div class="stat-card total">
                <div class="stat-title">Total entregas</div>
                <div class="stat-value">@TotalEntregas</div>
            </div>
        </div>

        <div class="calificar-content">
            <div class="empty-state" hidden="@tieneDatos">
                <i class="bi bi-clipboard-check" style="font-size: 3rem; color: var(--color-text-tertiary);"></i>
                <h2>Aún no hay entregas para calificar</h2>
                <p>
                    Cuando los estudiantes envíen sus archivos en el calendario,
                    verás aquí las actividades para revisar y asignar notas.
                </p>
            </div>

            @if (tieneDatos)
            {
                @foreach (var act in actividades)
                {
                    <div class="actividad-card">
                        <div class="actividad-header" @onclick="() => ToggleActividad(act.Id)">
                            <div class="actividad-info">
                                <strong>@act.Titulo</strong>
                                <span class="actividad-meta">@act.NombreAsignatura · @act.NombreGrupo</span>
                                @if (act.FechaLimite.HasValue)
                                {
                                    <span class="actividad-fecha">Límite: @act.FechaLimite.Value.ToString("dd/MM/yyyy")</span>
                                }
                            </div>
                            <span class="badge-pendientes">@act.Pendientes pendientes</span>
                            <i class="bi @(actividadExpandida == act.Id ? "bi-chevron-up" : "bi-chevron-down")"></i>
                        </div>
                        @if (actividadExpandida == act.Id)
                        {
                            <div class="actividad-entregas">
                                @if (entregasPorActividad.TryGetValue(act.IdRecurso, out var entregas) && entregas.Any())
                                {
                                    <table class="tabla-entregas">
                                        <thead>
                                            <tr>
                                                <th>Estudiante</th>
                                                <th>Archivo</th>
                                                <th>Nota</th>
                                                <th>Acción</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var e in entregas)
                                            {
                                                <tr>
                                                    <td>@e.NombreEstudiante</td>
                                                    <td>
                                                        @if (!string.IsNullOrEmpty(e.RutaArchivo))
                                                        {
                                                            <a href="@CalendarioService.GetUrlArchivoEntrega(e.RutaArchivo)" target="_blank" rel="noopener" class="link-archivo">@e.NombreArchivo</a>
                                                            <a href="@CalendarioService.GetUrlArchivoEntrega(e.RutaArchivo, descargar: true, nombreOriginal: e.NombreArchivo)" target="_blank" rel="noopener" class="link-descarga" title="Descargar"> <i class="bi bi-download"></i> </a>
                                                        }
                                                        else
                                                        {
                                                            @e.NombreArchivo
                                                        }
                                                    </td>
                                                    <td>
                                                        @if (editandoNotaId == e.IdNotaEstudiante)
                                                        {
                                                            <input type="number" step="0.01" min="0" max="100" @bind="notaTemporal" class="input-nota" />
                                                            <button type="button" class="btn-guardar-nota" @onclick="() => GuardarNota(e.IdNotaEstudiante)">Guardar</button>
                                                            <button type="button" class="btn-cancelar-nota" @onclick="CancelarEditarNota">Cancelar</button>
                                                        }
                                                        else
                                                        {
                                                            @(e.Nota.HasValue ? e.Nota.Value.ToString("N1") : "—")
                                                            <button type="button" class="btn-editar-nota" @onclick="() => EditarNota(e)">@(e.YaCalificado ? "Editar" : "Calificar")</button>
                                                        }
                                                    </td>
                                                    <td></td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                }
                                else
                                {
                                    <p class="cargando-entregas">Cargando entregas...</p>
                                }
                            </div>
                        }
                    </div>
                }
            }
        </div>
    }
</div>

<style>
    .calificar-page {
        max-width: 1200px;
        margin: 0 auto;
        padding: 2rem 1rem;
    }

    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 1.5rem;
        gap: 1rem;
    }

    .page-header-left h1 {
        font-size: 2rem;
        font-weight: 600;
        color: var(--color-text-primary);
        margin-bottom: 0.5rem;
    }

    .page-subtitle {
        color: var(--color-text-secondary);
        font-size: 0.95rem;
        max-width: 600px;
    }

    .filtro-grupo {
        margin-bottom: 1.5rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .filtro-grupo label {
        font-weight: 500;
        color: var(--color-text-secondary);
    }

    .select-filtro {
        padding: 0.5rem 0.75rem;
        border-radius: var(--border-radius-md, 6px);
        border: 1px solid var(--color-border, #ddd);
        min-width: 220px;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
    }

    .stat-card {
        padding: 1.25rem 1.5rem;
        border-radius: var(--border-radius-lg);
        box-shadow: 0 2px 8px var(--color-shadow);
        background-color: var(--color-bg-primary);
        display: flex;
        flex-direction: column;
        gap: 0.4rem;
    }

    .stat-card .stat-title {
        font-size: 0.9rem;
        font-weight: 500;
        color: var(--color-text-secondary);
    }

    .stat-card .stat-value {
        font-size: 1.8rem;
        font-weight: 700;
        color: var(--color-text-primary);
    }

    .stat-card.pending {
        border-left: 4px solid #ffc107;
    }

    .stat-card.graded {
        border-left: 4px solid #28a745;
    }

    .stat-card.total {
        border-left: 4px solid #0d6efd;
    }

    .loading-state {
        text-align: center;
        padding: 3rem;
        color: var(--color-text-secondary);
    }

    .spinner {
        width: 40px;
        height: 40px;
        border: 3px solid var(--color-border);
        border-top-color: #0d6efd;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
        margin: 0 auto 1rem;
    }

    @@keyframes spin {
        to { transform: rotate(360deg); }
    }

    .calificar-content {
        margin-top: 1rem;
    }

    .empty-state {
        text-align: center;
        padding: 3rem 1.5rem;
        background-color: var(--color-bg-secondary);
        border-radius: var(--border-radius-lg);
        border: 1px dashed var(--color-border);
    }

    .empty-state h2 {
        margin-top: 1rem;
        margin-bottom: 0.5rem;
        color: var(--color-text-primary);
    }

    .empty-state p {
        color: var(--color-text-secondary);
        max-width: 620px;
        margin: 0 auto;
        font-size: 0.95rem;
    }

    .actividad-card {
        background: var(--color-bg-primary);
        border-radius: var(--border-radius-lg);
        box-shadow: 0 2px 8px var(--color-shadow);
        margin-bottom: 1rem;
        overflow: hidden;
    }

    .actividad-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 1rem 1.25rem;
        cursor: pointer;
        gap: 1rem;
    }

    .actividad-header:hover {
        background: var(--color-bg-secondary, #f8f9fa);
    }

    .actividad-info {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
    }

    .actividad-meta, .actividad-fecha {
        font-size: 0.9rem;
        color: var(--color-text-secondary);
    }

    .badge-pendientes {
        background: #ffc107;
        color: #000;
        padding: 0.25rem 0.5rem;
        border-radius: 999px;
        font-size: 0.85rem;
        font-weight: 500;
    }

    .actividad-entregas {
        padding: 0 1.25rem 1rem;
        border-top: 1px solid var(--color-border);
    }

    .tabla-entregas {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.95rem;
    }

    .tabla-entregas th, .tabla-entregas td {
        padding: 0.6rem 0.75rem;
        text-align: left;
        border-bottom: 1px solid var(--color-border);
    }

    .tabla-entregas th {
        font-weight: 600;
        color: var(--color-text-secondary);
    }

    .link-archivo {
        color: #0d6efd;
        text-decoration: none;
    }

    .link-archivo:hover {
        text-decoration: underline;
    }

    .link-descarga {
        margin-left: 0.5rem;
        color: var(--color-text-secondary);
    }

    .input-nota {
        width: 70px;
        padding: 0.35rem 0.5rem;
        border-radius: 4px;
        border: 1px solid var(--color-border);
    }

    .btn-editar-nota, .btn-guardar-nota, .btn-cancelar-nota {
        margin-left: 0.5rem;
        padding: 0.25rem 0.5rem;
        font-size: 0.85rem;
        border-radius: 4px;
        border: 1px solid var(--color-border);
        cursor: pointer;
    }

    .btn-guardar-nota {
        background: #28a745;
        color: #fff;
        border-color: #28a745;
    }

    .btn-cancelar-nota {
        background: transparent;
        color: var(--color-text-secondary);
    }

    .cargando-entregas {
        padding: 1rem;
        color: var(--color-text-secondary);
        font-size: 0.9rem;
    }

    @@media (max-width: 768px) {
        .page-header { flex-direction: column; align-items: stretch; }
        .actividad-header { flex-wrap: wrap; }
        .tabla-entregas { font-size: 0.85rem; }
        .tabla-entregas th, .tabla-entregas td { padding: 0.5rem; }
    }
</style>

@code {
    private bool cargando = true;
    private int? idGrupoFiltro;
    private List<ActividadParaCalificarDto> actividades = new();
    private Dictionary<int, List<EntregaParaCalificarDto>> entregasPorActividad = new();
    private List<(int IdGrupo, string NombreGrupo)> gruposUnicos = new();
    private int? actividadExpandida;
    private int? editandoNotaId;
    private decimal notaTemporal;
    private int profesorId;

    private int TotalPendientes => actividades.Sum(a => a.Pendientes);
    private int TotalCalificadas => actividades.Sum(a => a.Calificadas);
    private int TotalEntregas => actividades.Sum(a => a.TotalEntregas);
    private bool tieneDatos => actividades.Count > 0;

    protected override async Task OnInitializedAsync()
    {
        var auth = await AuthStateProvider.GetAuthenticationStateAsync();
        var userIdClaim = auth?.User?.FindFirst(ClaimTypes.NameIdentifier)?.Value;
        if (string.IsNullOrEmpty(userIdClaim) || !int.TryParse(userIdClaim, out profesorId))
        {
            cargando = false;
            return;
        }

        var asignaturas = await AsignaturaService.ObtenerAsignaturasPorProfesor(profesorId);
        gruposUnicos = asignaturas
            .Where(a => a.GrupoId > 0)
            .Select(a => (IdGrupo: a.GrupoId, NombreGrupo: a.Grupo ?? $"Grupo {a.GrupoId}"))
            .Distinct()
            .OrderBy(x => x.NombreGrupo)
            .ToList();

        await CargarActividades();
        cargando = false;
    }

    private async Task OnGrupoChange(ChangeEventArgs e)
    {
        var val = e.Value?.ToString();
        idGrupoFiltro = int.TryParse(val, out var id) && id > 0 ? id : null;
        await CargarActividades();
    }

    private async Task CargarActividades()
    {
        actividades = await CalendarioService.ObtenerActividadesParaCalificarAsync(profesorId, idGrupoFiltro);
        entregasPorActividad.Clear();
        actividadExpandida = null;
        StateHasChanged();
    }

    private async Task ToggleActividad(int idAsignacionAcademicaRecurso)
    {
        var act = actividades.FirstOrDefault(a => a.Id == idAsignacionAcademicaRecurso);
        if (act == null) return;
        if (actividadExpandida == idAsignacionAcademicaRecurso)
        {
            actividadExpandida = null;
            StateHasChanged();
            return;
        }
        actividadExpandida = idAsignacionAcademicaRecurso;
        if (!entregasPorActividad.ContainsKey(act.IdRecurso))
        {
            var entregas = await CalendarioService.ObtenerEntregasParaCalificarAsync(act.IdRecurso);
            entregasPorActividad[act.IdRecurso] = entregas;
        }
        StateHasChanged();
    }

    private void EditarNota(EntregaParaCalificarDto e)
    {
        editandoNotaId = e.IdNotaEstudiante;
        notaTemporal = e.Nota ?? 0;
        StateHasChanged();
    }

    private void CancelarEditarNota()
    {
        editandoNotaId = null;
        StateHasChanged();
    }

    private async Task GuardarNota(int idNotaEstudiante)
    {
        var ok = await CalendarioService.AsignarNotaAsync(idNotaEstudiante, notaTemporal);
        if (ok)
        {
            foreach (var list in entregasPorActividad.Values)
            {
                var ent = list.FirstOrDefault(x => x.IdNotaEstudiante == idNotaEstudiante);
                if (ent != null)
                {
                    ent.Nota = notaTemporal;
                    ent.YaCalificado = true;
                    break;
                }
            }
            var act = actividades.FirstOrDefault(a => entregasPorActividad.ContainsKey(a.IdRecurso) && entregasPorActividad[a.IdRecurso].Any(x => x.IdNotaEstudiante == idNotaEstudiante));
            if (act != null)
            {
                act.Calificadas = entregasPorActividad[act.IdRecurso].Count(x => x.YaCalificado);
                act.Pendientes = act.TotalEntregas - act.Calificadas;
            }
        }
        editandoNotaId = null;
        StateHasChanged();
    }
}
