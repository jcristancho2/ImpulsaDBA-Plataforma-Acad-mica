@page "/"
@page "/login"
@layout EmptyLayout
@using ImpulsaDBA.Client.Services
@using ImpulsaDBA.Shared.Requests
@using ImpulsaDBA.Shared.Responses
@using ImpulsaDBA.Client.Auth
@using Microsoft.AspNetCore.Components.Authorization
@using ImpulsaDBA.Client.Components.Layout
@using ImpulsaDBA.Client.Components.Shared
@using Microsoft.AspNetCore.Components.Web
@inject AuthService AuthService
@inject CustomAuthStateProvider AuthStateProvider
@inject NavigationManager Navigation

<PageTitle>Iniciar Sesión - ImpulsaDBA</PageTitle>

<div class="login-container">
    <div class="login-box">
        <div class="login-header">
            <h1>Plataforma Académica</h1>
            <p>Ingresa tus credenciales para continuar</p>
        </div>

        <EditForm Model="@loginModel" OnValidSubmit="@HandleLogin">
            <DataAnnotationsValidator />
            
            @if (!string.IsNullOrEmpty(mensajeError))
            {
                <div class="alert alert-danger" role="alert">
                    @mensajeError
                </div>
            }

            <div class="form-group">
                <label for="usuario">Usuario</label>
                <InputText id="usuario" 
                        class="form-control" 
                        @bind-Value="loginModel.Usuario" 
                        placeholder="ingrese correo, cedula o celular" />
                <ValidationMessage For="@(() => loginModel.Usuario)" />
            </div>

            <div class="form-group">
                <label for="password">Contraseña</label>
                <InputText id="password" 
                        type="password" 
                        class="form-control" 
                        @bind-Value="loginModel.Password" 
                        placeholder="ingrese su contraseña" />
                <ValidationMessage For="@(() => loginModel.Password)" />
            </div>

            <div class="login-options">
                <div class="login-remember">
                    <input type="checkbox" id="remember" @bind="recordarme" />
                    <label for="remember">Recordarme</label>
                </div>
                <a href="#" class="login-forgot" @onclick="AbrirModalOlvideContrasena" @onclick:preventDefault>¿Olvidó su contraseña?</a>
            </div>

            <button type="submit" 
                    class="btn-login" 
                    disabled="@isLoading">
                @if (isLoading)
                {
                    <span class="spinner"></span>
                    <span>Iniciando sesión...</span>
                }
                else
                {
                    <span>Iniciar Sesión</span>
                }
            </button>
        </EditForm>

        <div class="login-footer">
            <p>
                ¿Problemas para acceder? <a href="#" @onclick:preventDefault>Contactar soporte</a>
            </p>
        </div>
    </div>
</div>

<!-- Modal Olvidé Contraseña -->
<ModalOlvideContrasena Mostrar="@mostrarModalOlvideContrasena" OnCerrar="CerrarModalOlvideContrasena" />

@code {
    private LoginFormModel loginModel = new LoginFormModel();
    private string? mensajeError;
    private bool isLoading = false;
    private bool recordarme = false;
    private bool mostrarModalOlvideContrasena = false;

    /// <summary>
    /// Modelo para el formulario de login.
    /// </summary>
    public class LoginFormModel
    {
        [System.ComponentModel.DataAnnotations.Required(ErrorMessage = "El usuario es requerido (correo, cédula o celular)")]
        public string? Usuario { get; set; }

        [System.ComponentModel.DataAnnotations.Required(ErrorMessage = "El número de documento es requerido")]
        public string? Password { get; set; }
    }

    /// <summary>
    /// Maneja el proceso de login cuando el formulario es válido.
    /// 
    /// PROCESO:
    /// 1. Valida credenciales usando AuthService (consulta a base de datos SQL Server)
    /// 2. Si es válido, guarda sesión en LocalStorage usando CustomAuthStateProvider
    /// 3. Redirige a Dashboard (/dashboard o /)
    /// 4. Si hay error, muestra mensaje al usuario
    /// </summary>
    private async Task HandleLogin()
    {
        mensajeError = null;
        isLoading = true;

        try
        {
            // Validar credenciales contra la API
            // El usuario puede ser correo, cédula o celular
            // La contraseña siempre es el número de documento
            var loginResponse = await AuthService.ValidarLoginCompleto(
                loginModel.Usuario ?? string.Empty, 
                loginModel.Password ?? string.Empty
            );

            if (loginResponse == null || !loginResponse.Success || loginResponse.Usuario == null)
            {
                mensajeError = loginResponse?.Message ?? "Credenciales incorrectas. Verifique su usuario (correo, cédula o celular) y número de documento.";
                isLoading = false;
                return;
            }

            // Crear sesión del usuario desde la respuesta
            var sesion = new SesionUsuarioResponse
            {
                UsuarioId = loginResponse.Usuario.UsuarioId,
                NombreCompleto = loginResponse.Usuario.NombreCompleto,
                Email = loginResponse.Usuario.Email,
                Perfil = loginResponse.Usuario.Perfil,
                FotoUrl = loginResponse.Usuario.FotoUrl,
                Token = loginResponse.Token ?? Guid.NewGuid().ToString()
            };

            // Guardar sesión en LocalStorage (navegador del cliente)
            // CustomAuthStateProvider guarda la sesión y actualiza el estado de autenticación
            await AuthStateProvider.GuardarSesionAsync(sesion);

            // Redirigir a la vista de inicio (según pendientes.md punto 2)
            Navigation.NavigateTo("/dashboard/inicio", forceLoad: true);
        }
        catch (Exception ex)
        {
            mensajeError = $"Error al iniciar sesión: {ex.Message}";
            Console.WriteLine($"Error en login: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private void AbrirModalOlvideContrasena()
    {
        mostrarModalOlvideContrasena = true;
    }

    private void CerrarModalOlvideContrasena()
    {
        mostrarModalOlvideContrasena = false;
    }
}
