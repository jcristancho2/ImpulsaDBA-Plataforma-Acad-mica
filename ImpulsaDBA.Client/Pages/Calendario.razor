@page "/dashboard/calendario"
@layout DashboardLayout
@using Microsoft.AspNetCore.Components.Authorization
@using System.Linq
@using System.Security.Claims
@using ImpulsaDBA.Shared.DTOs
@using ImpulsaDBA.Client.Components.Shared
@using ImpulsaDBA.Client.Components.Calendario.CreacionActividades
@using ImpulsaDBA.Client.Services
@using Microsoft.JSInterop
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager Navigation
@inject AsignaturaService AsignaturaService
@inject CalendarioService CalendarioService
@inject IJSRuntime JSRuntime
@attribute [Microsoft.AspNetCore.Authorization.Authorize]

<PageTitle>Calendario - ImpulsaDBA</PageTitle>

<div class="calendario-page">
    @if (mostrarMensajeExito && !string.IsNullOrEmpty(mensajeExito))
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert" style="position: fixed; top: 20px; right: 20px; z-index: 9999; min-width: 300px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
            <strong>@mensajeExito</strong>
            <button type="button" class="btn-close" @onclick="@(() => { mostrarMensajeExito = false; mensajeExito = null; })" aria-label="Close"></button>
        </div>
    }
    
    @if (isLoading)
    {
        <div class="loading-container">
            <div class="spinner"></div>
            <p>Cargando calendario...</p>
        </div>
    }
    else
    {
        <div class="page-header">
            <div class="page-header-left">
                <h1>Calendario Acad√©mico</h1>
            </div>
            <div class="page-header-right">
                <Ayudas IdComponente="105" />
            </div>
        </div>

        <div class="calendario-wrapper">
            <CalendarioComponent IdAsignacionAcademica="@idAsignacionAcademicaActual" 
                                GrupoId="@(tipoFiltro == "grupo" ? grupoSeleccionado?.GrupoId ?? 0 : 0)"
                                TipoFiltro="@tipoFiltro"
                                OnDiaSeleccionado="OnDiaClick"
                                OnActividadSeleccionada="OnActividadClick"
                                OnActividadEliminada="RecargarCalendarioDespuesEliminar"
                                @ref="calendarioComponentRef">
                <HeaderFilters>
                    <div class="filtros-container">
                        <div class="filtro-item filtro-tipo-vista">
                            <span class="filtro-tipo-vista-label">Vista:</span>
                            <div class="filtro-tipo-vista-radios">
                                <label class="filtro-tipo-vista-radio">
                                    <input type="radio" name="tipoFiltro" value="grupo" checked="@(tipoFiltro == "grupo")" @onchange="@(() => OnTipoFiltroChange("grupo"))" />
                                    <span>Por grupos</span>
                                </label>
                                <label class="filtro-tipo-vista-radio">
                                    <input type="radio" name="tipoFiltro" value="asignaturas" checked="@(tipoFiltro == "asignaturas")" @onchange="@(() => OnTipoFiltroChange("asignaturas"))" />
                                    <span>Mis Asignaturas</span>
                                </label>
                            </div>
                        </div>
                        @if (tipoFiltro == "asignaturas")
                        {
                            <div class="filtro-item">
                                <label for="select-asignatura"></label>
                                <select id="select-asignatura" class="select-filtro" @onchange="OnAsignaturaChange">
                                    <option value="0">Todas las asignaturas</option>
                                    @foreach (var asignatura in asignaturasFiltradas)
                                    {
                                        <option value="@asignatura.IdAsignacionAcademica" selected="@(asignaturaSeleccionada?.IdAsignacionAcademica == asignatura.IdAsignacionAcademica)">
                                            @asignatura.Nombre - @asignatura.Grupo
                                        </option>
                                    }
                                </select>
                            </div>
                        }
                        else
                        {
                            <div class="filtro-item">
                                <label for="select-grupo"></label>
                                <select id="select-grupo" class="select-filtro" @onchange="OnGrupoChange">
                                    <option value="0">Seleccione un grupo</option>
                                    @foreach (var grupo in gruposDisponibles)
                                    {
                                        <option value="@grupo.GrupoId" selected="@(grupoSeleccionado?.GrupoId == grupo.GrupoId)">
                                            @grupo.NombreGrupo
                                        </option>
                                    }
                                </select>
                            </div>
                        }
                    </div>
                </HeaderFilters>
            </CalendarioComponent>
        </div>
    }
</div>

<ModalActividad Mostrar="@mostrarModal" 
                FechaSeleccionada="@fechaSeleccionadaModal"
                OnTipoSeleccionado="OnTipoActividadSeleccionado"
                OnCerrar="CerrarModal" />

<!-- Modales espec√≠ficos de creaci√≥n -->
<!-- Modal 1: Video de Enganche -->
<VideoDeEnganche Mostrar="@mostrarVideoEngancheModal"
                 FechaSeleccionada="@fechaSeleccionadaModal"
                 IdAsignacionAcademica="@idAsignacionAcademicaActual"
                 ActividadEditar="@(actividadEditando?.IdTipoActividad == 1 ? actividadEditando : null)"
                 ModoSoloLectura="@(tipoFiltro == "grupo" || (actividadEditando != null && actividadEditando.IdTipoActividad == 1 && !(usuarioIdActual.HasValue && actividadEditando.IdProfesor.HasValue && actividadEditando.IdProfesor.Value == usuarioIdActual.Value)))"
                 OnCerrar="CerrarVideoEngancheModal"
                 OnActividadGuardada="RecargarCalendarioDespuesGuardar" />

<!-- Modal 2: Preguntas Problematizadoras -->
<PreguntasProblematizadoras Mostrar="@mostrarPreguntasModal"
                            FechaSeleccionada="@fechaSeleccionadaModal"
                            IdAsignacionAcademica="@idAsignacionAcademicaActual"
                            ActividadEditar="@(actividadEditando?.IdTipoActividad == 2 ? actividadEditando : null)"
                            ModoSoloLectura="@(tipoFiltro == "grupo" || (actividadEditando != null && actividadEditando.IdTipoActividad == 2 && !(usuarioIdActual.HasValue && actividadEditando.IdProfesor.HasValue && actividadEditando.IdProfesor.Value == usuarioIdActual.Value)))"
                            OnCerrar="CerrarPreguntasModal"
                            OnActividadGuardada="RecargarCalendarioDespuesGuardar" />

<!-- Modal 3: Recurso Interactivo (Lecci√≥n Interactiva / Juego Educativo) -->
<RecursoInteractivo Mostrar="@mostrarRecursoInteractivoModal"
                    FechaSeleccionada="@fechaSeleccionadaModal"
                    IdAsignacionAcademica="@idAsignacionAcademicaActual"
                    TipoActividadId="@tipoActividadSeleccionadoId"
                    ActividadEditar="@(actividadEditando != null && (actividadEditando.IdTipoActividad == 3 || actividadEditando.IdTipoActividad == 10) ? actividadEditando : null)"
                    ModoSoloLectura="@(tipoFiltro == "grupo" || (actividadEditando != null && (actividadEditando.IdTipoActividad == 3 || actividadEditando.IdTipoActividad == 10) && !(usuarioIdActual.HasValue && actividadEditando.IdProfesor.HasValue && actividadEditando.IdProfesor.Value == usuarioIdActual.Value)))"
                    OnCerrar="CerrarRecursoInteractivoModal"
                    OnActividadGuardada="RecargarCalendarioDespuesGuardar" />

<!-- Modal 4: Asignaciones (Tarea, Trabajo, Taller, Investigaci√≥n, Proyecto, Actividad Pr√°ctica) -->
<Asignaciones Mostrar="@mostrarAsignacionesModal"
              FechaSeleccionada="@fechaSeleccionadaModal"
              IdAsignacionAcademica="@idAsignacionAcademicaActual"
              TipoActividadId="@tipoActividadSeleccionadoId"
              ActividadEditar="@(actividadEditando != null && (actividadEditando.IdTipoActividad >= 4 && actividadEditando.IdTipoActividad <= 9) ? actividadEditando : null)"
              ModoSoloLectura="@(tipoFiltro == "grupo" || (actividadEditando != null && (actividadEditando.IdTipoActividad >= 4 && actividadEditando.IdTipoActividad <= 9) && !(usuarioIdActual.HasValue && actividadEditando.IdProfesor.HasValue && actividadEditando.IdProfesor.Value == usuarioIdActual.Value)))"
              OnCerrar="CerrarAsignacionesModal"
              OnActividadGuardada="RecargarCalendarioDespuesGuardar" />

<!-- Modal 5: Material de Apoyo (Presentaci√≥n, Documento, Recurso de Lectura, Resumen de Clase) -->
<MaterialApoyo Mostrar="@mostrarMaterialApoyoModal"
               FechaSeleccionada="@fechaSeleccionadaModal"
               IdAsignacionAcademica="@idAsignacionAcademicaActual"
               TipoActividadId="@tipoActividadSeleccionadoId"
               ActividadEditar="@(actividadEditando != null && (actividadEditando.IdTipoActividad == 11 || actividadEditando.IdTipoActividad == 12 || actividadEditando.IdTipoActividad == 13 || actividadEditando.IdTipoActividad == 16) ? actividadEditando : null)"
               ModoSoloLectura="@(tipoFiltro == "grupo" || (actividadEditando != null && (actividadEditando.IdTipoActividad == 11 || actividadEditando.IdTipoActividad == 12 || actividadEditando.IdTipoActividad == 13 || actividadEditando.IdTipoActividad == 16) && !(usuarioIdActual.HasValue && actividadEditando.IdProfesor.HasValue && actividadEditando.IdProfesor.Value == usuarioIdActual.Value)))"
               OnCerrar="CerrarMaterialApoyoModal"
               OnActividadGuardada="RecargarCalendarioDespuesGuardar" />

<!-- Modal 6: Clase Virtual -->
<ClaseVirtual Mostrar="@mostrarClaseVirtualModal"
              FechaSeleccionada="@fechaSeleccionadaModal"
              IdAsignacionAcademica="@idAsignacionAcademicaActual"
              ActividadEditar="@(actividadEditando?.IdTipoActividad == 14 ? actividadEditando : null)"
              ModoSoloLectura="@(tipoFiltro == "grupo" || (actividadEditando != null && actividadEditando.IdTipoActividad == 14 && !(usuarioIdActual.HasValue && actividadEditando.IdProfesor.HasValue && actividadEditando.IdProfesor.Value == usuarioIdActual.Value)))"
              OnCerrar="CerrarClaseVirtualModal"
              OnActividadGuardada="RecargarCalendarioDespuesGuardar" />

<!-- Modal 7: Evaluaci√≥n -->
<Evaluacion Mostrar="@mostrarEvaluacionModal"
            FechaSeleccionada="@fechaSeleccionadaModal"
            IdAsignacionAcademica="@idAsignacionAcademicaActual"
            ActividadEditar="@(actividadEditando?.IdTipoActividad == 17 ? actividadEditando : null)"
            ModoSoloLectura="@(tipoFiltro == "grupo" || (actividadEditando != null && actividadEditando.IdTipoActividad == 17 && !(usuarioIdActual.HasValue && actividadEditando.IdProfesor.HasValue && actividadEditando.IdProfesor.Value == usuarioIdActual.Value)))"
            OnCerrar="CerrarEvaluacionModal"
            OnActividadGuardada="RecargarCalendarioDespuesGuardar" />

<style>
    .calendario-page {
        max-width: 100%;
        width: 100%;
        margin: 0;
        display: flex;
        flex-direction: column;
        flex: 1;
        min-width: 0;
        overflow: hidden;
    }

    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 2rem;
        gap: 1rem;
    }

    .page-header-left {
        flex: 1;
    }

    .page-header-right {
        display: flex;
        align-items: center;
    }

    .page-header h1 {
        font-size: 2rem;
        font-weight: 600;
        color: var(--color-text-primary);
        margin-bottom: 1rem;
    }

    .filtros-container {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        justify-content: center;
        width: 100%;

    }

    .filtro-item {
        display: flex;
        flex-direction: row;
        gap: 0.25rem;

    }

    .filtros-container label {
        font-weight: 500;
        color: var(--color-text-primary);
        font-size: 0.6rem;

    }

    .filtro-tipo-vista {
        display: flex;
        flex-direction: row;
        gap: 0.35rem;
    }

    .filtro-tipo-vista-label {
        font-weight: 500;
        color: var(--color-text-primary);
        font-size: 0.6rem;
    }

    .filtro-tipo-vista-radios {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 1.1rem;
    }

    .filtro-tipo-vista-radio {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        cursor: pointer;
        font-size: 0.9rem;
        color: var(--color-text-primary);
    }

    .filtro-tipo-vista-radio input {
        cursor: pointer;
        width: 1rem;
        height: 1rem;
    }

    .select-filtro {
        padding: 0.25rem 0.5rem;
        border: 1px solid var(--color-border);
        border-radius: var(--border-radius-md);
        background-color: var(--color-bg-primary);
        color: var(--color-text-primary);
        font-size: 0.9rem;
        cursor: pointer;
        min-width: 200px;
    }

    .select-filtro:focus {
        outline: none;
        border-color: var(--color-primary);
    }

    .calendario-wrapper {
        flex: 1;
        min-height: 0;
        margin-top: 0.5rem;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    .loading-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 400px;
        gap: 1rem;
    }

    .spinner {
        width: 40px;
        height: 40px;
        border: 4px solid var(--color-border);
        border-top-color: var(--color-primary);
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @@keyframes spin {
        to { transform: rotate(360deg); }
    }

    @@media (max-width: 768px) {
        .page-header {
            flex-direction: column;
            align-items: stretch;
        }

        .page-header-right {
            align-self: flex-end;
            margin-top: 1rem;
        }

        .filtros-container {
            flex-direction: column;
            align-items: stretch;
            gap: 1rem;
        }

        .filtro-item {
            width: 100%;
        }

        .select-filtro {
            width: 100%;
            min-width: auto;
        }
    }
</style>

@code {
    private CalendarioComponent? calendarioComponentRef;
    private List<AsignaturaDto> asignaturas = new();
    private List<AsignaturaDto> asignaturasFiltradas = new();
    private AsignaturaDto? asignaturaSeleccionada;
    
    // Modelo para grupos √∫nicos
    private class GrupoInfo
    {
        public int GrupoId { get; set; }
        public string NombreGrupo { get; set; } = string.Empty;
    }
    
    private List<GrupoInfo> gruposDisponibles = new();
    private GrupoInfo? grupoSeleccionado;
    private string tipoFiltro = "asignaturas"; // "asignaturas" o "grupo" (igual que app estudiante)
    
    private int idAsignacionAcademicaActual = 0;
    private bool isLoading = true;
    private bool mostrarModal = false;
    private DateTime fechaSeleccionadaModal = DateTime.Today;
    
    // Modales espec√≠ficos
    private bool mostrarVideoEngancheModal = false;
    private bool mostrarPreguntasModal = false;
    private bool mostrarRecursoInteractivoModal = false;
    private bool mostrarAsignacionesModal = false;
    private bool mostrarMaterialApoyoModal = false;
    private bool mostrarClaseVirtualModal = false;
    private bool mostrarEvaluacionModal = false;
    private int tipoActividadSeleccionadoId = 0;
    private ActividadCalendarioDto? actividadEditando = null;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var userIdClaim = authState?.User?.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;

            if (!string.IsNullOrEmpty(userIdClaim) && int.TryParse(userIdClaim, out int profesorId))
            {
                usuarioIdActual = profesorId; // Guardar el UsuarioId para validaciones posteriores
                asignaturas = await AsignaturaService.ObtenerAsignaturasPorProfesor(profesorId);
                
                // Obtener grupos √∫nicos de las asignaturas
                gruposDisponibles = asignaturas
                    .GroupBy(a => new { a.GrupoId, a.Grupo })
                    .Select(g => new GrupoInfo
                    {
                        GrupoId = g.Key.GrupoId,
                        NombreGrupo = g.Key.Grupo
                    })
                    .OrderBy(g => g.NombreGrupo)
                    .ToList();
                
                // Inicializar asignaturas filtradas con todas las asignaturas
                asignaturasFiltradas = asignaturas.ToList();
                
                // Obtener asignaci√≥n o asignaturaId de query string si existe (asignacion = IdAsignacionAcademica, evita mostrar otro grupo)
                var uri = Navigation.ToAbsoluteUri(Navigation.Uri);
                var query = uri.Query.TrimStart('?');
                var queryParams = query.Split('&')
                    .Select(p => p.Split('='))
                    .Where(p => p.Length == 2)
                    .ToDictionary(p => Uri.UnescapeDataString(p[0]), p => Uri.UnescapeDataString(p[1]));
                if (queryParams.TryGetValue("asignacion", out var idAsignacionStr))
                {
                    if (int.TryParse(idAsignacionStr, out int idAsignacion))
                    {
                        asignaturaSeleccionada = asignaturas.FirstOrDefault(a => a.IdAsignacionAcademica == idAsignacion);
                        if (asignaturaSeleccionada != null)
                        {
                            idAsignacionAcademicaActual = asignaturaSeleccionada.IdAsignacionAcademica;
                            grupoSeleccionado = gruposDisponibles.FirstOrDefault(g => g.GrupoId == asignaturaSeleccionada.GrupoId);
                        }
                    }
                }
                else if (queryParams.TryGetValue("asignaturaId", out var asignaturaIdStr))
                {
                    if (int.TryParse(asignaturaIdStr, out int asignaturaId))
                    {
                        asignaturaSeleccionada = asignaturas.FirstOrDefault(a => a.Id == asignaturaId);
                        if (asignaturaSeleccionada != null)
                        {
                            idAsignacionAcademicaActual = asignaturaSeleccionada.IdAsignacionAcademica;
                            grupoSeleccionado = gruposDisponibles.FirstOrDefault(g => g.GrupoId == asignaturaSeleccionada.GrupoId);
                        }
                    }
                }
                if (asignaturaSeleccionada == null && asignaturas.Count > 0)
                {
                    asignaturaSeleccionada = asignaturas.First();
                    idAsignacionAcademicaActual = asignaturaSeleccionada.IdAsignacionAcademica;
                    grupoSeleccionado = gruposDisponibles.FirstOrDefault(g => g.GrupoId == asignaturaSeleccionada.GrupoId);
                }
                // Por defecto vista por grupos: asegurar un grupo seleccionado
                if (tipoFiltro == "grupo" && grupoSeleccionado == null && gruposDisponibles.Count > 0)
                {
                    grupoSeleccionado = gruposDisponibles.First();
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error al cargar calendario: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private void OnTipoFiltroChange(string value)
    {
        tipoFiltro = value ?? "asignaturas";
        
        if (tipoFiltro == "grupo")
        {
            asignaturaSeleccionada = null;
            idAsignacionAcademicaActual = 0;
        }
        else
        {
            if (asignaturas.Count > 0 && asignaturaSeleccionada == null)
            {
                asignaturaSeleccionada = asignaturas.First();
                idAsignacionAcademicaActual = asignaturaSeleccionada.IdAsignacionAcademica;
            }
        }
        
        StateHasChanged();
    }

    private void OnGrupoChange(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out int grupoId))
        {
            if (grupoId == 0)
            {
                grupoSeleccionado = null;
            }
            else
            {
                grupoSeleccionado = gruposDisponibles.FirstOrDefault(g => g.GrupoId == grupoId);
            }
            
            // Cuando se filtra por grupo, no se usa idAsignacionAcademicaActual
            idAsignacionAcademicaActual = 0;
            
            StateHasChanged();
        }
    }

    private void OnAsignaturaChange(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out int idAsignacion))
        {
            if (idAsignacion == 0)
            {
                asignaturaSeleccionada = null;
                idAsignacionAcademicaActual = 0;
            }
            else
            {
                asignaturaSeleccionada = asignaturasFiltradas.FirstOrDefault(a => a.IdAsignacionAcademica == idAsignacion);
                if (asignaturaSeleccionada != null)
                {
                    idAsignacionAcademicaActual = idAsignacion;
                    // Actualizar grupo seleccionado seg√∫n la asignatura
                    grupoSeleccionado = gruposDisponibles.FirstOrDefault(g => g.GrupoId == asignaturaSeleccionada.GrupoId);
                }
            }
            StateHasChanged();
        }
    }

    private async Task OnDiaClick(DateTime fecha)
    {
        Console.WriteLine($"üìÖ Click en fecha: {fecha:yyyy-MM-dd}");
        fechaSeleccionadaModal = fecha;

        // Con filtro por grupo: no se permite crear actividades, solo visualizar
        if (tipoFiltro == "grupo")
        {
            await JSRuntime.InvokeVoidAsync("alert", "En la vista por grupo (todos los docentes) solo se permite visualizar actividades. Para crear o editar, use la vista 'Mis Asignaturas'.");
            return;
        }
        
        // Si estamos en modo grupo y no hay asignaci√≥n acad√©mica, obtener una del grupo
        if (tipoFiltro == "grupo" && grupoSeleccionado != null && idAsignacionAcademicaActual == 0)
        {
            try
            {
                var idAsignacion = await AsignaturaService.ObtenerPrimeraAsignacionAcademicaPorGrupo(grupoSeleccionado.GrupoId);
                if (idAsignacion > 0)
                {
                    idAsignacionAcademicaActual = idAsignacion;
                    Console.WriteLine($"‚úÖ Asignaci√≥n acad√©mica obtenida del grupo: {idAsignacion}");
                }
                else
                {
                    Console.WriteLine($"‚ùå No se pudo obtener asignaci√≥n acad√©mica del grupo {grupoSeleccionado.GrupoId}");
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"‚ùå Error al obtener asignaci√≥n acad√©mica del grupo: {ex.Message}");
                // Mostrar mensaje de error al usuario
                // Por ahora solo logueamos el error
            }
        }
        // Si estamos en modo asignaturas y no hay asignaci√≥n acad√©mica seleccionada
        else if (tipoFiltro == "asignaturas" && idAsignacionAcademicaActual == 0)
        {
            Console.WriteLine($"‚ö†Ô∏è Advertencia: No hay asignaci√≥n acad√©mica seleccionada en modo asignaturas");
            await JSRuntime.InvokeVoidAsync("alert", "Por favor, seleccione una asignatura antes de crear una actividad.");
            return;
        }
        
        mostrarModal = true;
        Console.WriteLine($"‚úÖ Modal activado: mostrarModal = {mostrarModal}, IdAsignacion: {idAsignacionAcademicaActual}, TipoFiltro: {tipoFiltro}");
        StateHasChanged();
    }

    private async Task OnTipoActividadSeleccionado(TipoActividadDto tipo)
    {
        tipoActividadSeleccionadoId = tipo.Id;
        
        // Si estamos en modo grupo y no hay asignaci√≥n acad√©mica, obtener una del grupo
        if (tipoFiltro == "grupo" && grupoSeleccionado != null && idAsignacionAcademicaActual == 0)
        {
            try
            {
                var idAsignacion = await AsignaturaService.ObtenerPrimeraAsignacionAcademicaPorGrupo(grupoSeleccionado.GrupoId);
                if (idAsignacion > 0)
                {
                    idAsignacionAcademicaActual = idAsignacion;
                    Console.WriteLine($"‚úÖ Asignaci√≥n acad√©mica obtenida del grupo en OnTipoActividadSeleccionado: {idAsignacion}");
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"‚ùå Error al obtener asignaci√≥n acad√©mica del grupo: {ex.Message}");
            }
        }
        
        // Validar que tenemos una asignaci√≥n acad√©mica v√°lida antes de abrir el modal
        if (idAsignacionAcademicaActual <= 0)
        {
            Console.WriteLine($"‚ùå Error: No se puede crear actividad sin asignaci√≥n acad√©mica. IdAsignacion: {idAsignacionAcademicaActual}, TipoFiltro: {tipoFiltro}, GrupoId: {grupoSeleccionado?.GrupoId ?? 0}");
            
            // Mostrar mensaje de error al usuario usando JavaScript
            await JSRuntime.InvokeVoidAsync("alert", 
                tipoFiltro == "grupo" 
                    ? "No se pudo obtener una asignaci√≥n acad√©mica del grupo seleccionado. Por favor, intente nuevamente."
                    : "Por favor, seleccione una asignatura antes de crear una actividad.");
            return;
        }
        
        // Cerrar el modal principal
        await CerrarModal();
        
        // Abrir el modal espec√≠fico seg√∫n el tipo (IDs de tipo_recurso)
        switch (tipo.Id)
        {
            case 1: // Modal 1: Video de Enganche
                mostrarVideoEngancheModal = true;
                break;
            case 2: // Modal 2: Preguntas problematizadoras
                mostrarPreguntasModal = true;
                break;
            case 3: // Modal 3: Lecci√≥n Interactiva
            case 10: // Modal 3: Juego Educativo
                mostrarRecursoInteractivoModal = true;
                break;
            case 4: // Modal 4: Tarea
            case 5: // Modal 4: Trabajo
            case 6: // Modal 4: Taller
            case 7: // Modal 4: Investigaci√≥n
            case 8: // Modal 4: Proyecto
            case 9: // Modal 4: Actividad Pr√°ctica
                mostrarAsignacionesModal = true;
                break;
            case 11: // Modal 5: Presentaci√≥n (Sliders)
            case 12: // Modal 5: Documento (Archivo)
            case 13: // Modal 5: Recurso de Lectura
            case 16: // Modal 5: Resumen de Clase (gu√≠a de clase)
                mostrarMaterialApoyoModal = true;
                break;
            case 14: // Modal 6: Clase Virtual
                mostrarClaseVirtualModal = true;
                break;
            case 17: // Modal 7: Evaluaci√≥n
                mostrarEvaluacionModal = true;
                break;
            default:
                // Para otros tipos, por ahora solo mostrar mensaje
                Console.WriteLine($"Tipo seleccionado: {tipo.Nombre} (ID: {tipo.Id}) para fecha: {fechaSeleccionadaModal:yyyy-MM-dd}");
                break;
        }
        
        StateHasChanged();
    }
    
    private async Task CerrarVideoEngancheModal()
    {
        mostrarVideoEngancheModal = false;
        actividadEditando = null;
        StateHasChanged();
    }
    
    private async Task CerrarPreguntasModal()
    {
        mostrarPreguntasModal = false;
        actividadEditando = null;
        StateHasChanged();
    }
    
    private async Task CerrarRecursoInteractivoModal()
    {
        mostrarRecursoInteractivoModal = false;
        tipoActividadSeleccionadoId = 0;
        actividadEditando = null;
        StateHasChanged();
    }
    
    private async Task CerrarAsignacionesModal()
    {
        mostrarAsignacionesModal = false;
        tipoActividadSeleccionadoId = 0;
        actividadEditando = null;
        StateHasChanged();
    }
    
    private async Task CerrarMaterialApoyoModal()
    {
        mostrarMaterialApoyoModal = false;
        tipoActividadSeleccionadoId = 0;
        actividadEditando = null;
        StateHasChanged();
    }
    
    private async Task CerrarClaseVirtualModal()
    {
        mostrarClaseVirtualModal = false;
        actividadEditando = null;
        StateHasChanged();
    }
    
    private async Task CerrarEvaluacionModal()
    {
        mostrarEvaluacionModal = false;
        actividadEditando = null;
        StateHasChanged();
    }

    private async Task CerrarModal()
    {
        mostrarModal = false;
        StateHasChanged();
    }

    private string? mensajeExito = null;
    private bool mostrarMensajeExito = false;

    private async Task RecargarCalendarioDespuesGuardar()
    {
        try
        {
            // Una sola recarga del calendario (evita m√∫ltiples renderizados)
            if (calendarioComponentRef != null)
            {
                await calendarioComponentRef.RecargarCalendario();
            }

            mensajeExito = "‚úì Actividad guardada exitosamente en la base de datos";
            mostrarMensajeExito = false;
            actividadEditando = null;
            StateHasChanged();

            await Task.Delay(3000);
            mostrarMensajeExito = false;
            mensajeExito = null;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"‚ùå Error al recargar calendario: {ex.Message}");
        }
    }

    private void RecargarCalendarioDespuesEliminar()
    {
        actividadEditando = null;
        StateHasChanged();
    }

    private int? usuarioIdActual = null;

    private async Task OnActividadClick(ActividadCalendarioDto actividad)
    {
        // Asegurar que tenemos el usuarioIdActual
        if (!usuarioIdActual.HasValue)
        {
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var usuarioIdClaim = authState?.User?.FindFirst(ClaimTypes.NameIdentifier)?.Value;
            
            if (!string.IsNullOrEmpty(usuarioIdClaim) && int.TryParse(usuarioIdClaim, out int usuarioId))
            {
                usuarioIdActual = usuarioId;
            }
        }

        actividadEditando = actividad;
        tipoActividadSeleccionadoId = actividad.IdTipoActividad;
        fechaSeleccionadaModal = actividad.FechaInicio;

        // Abrir el modal correspondiente seg√∫n el tipo de actividad
        // Si no es el creador, el modal se abrir√° en modo solo lectura
        switch (actividad.IdTipoActividad)
        {
            case 1: // Video de Enganche
                mostrarVideoEngancheModal = true;
                break;
            case 2: // Preguntas problematizadoras
                mostrarPreguntasModal = true;
                break;
            case 3: // Lecci√≥n Interactiva
            case 10: // Juego Educativo
                mostrarRecursoInteractivoModal = true;
                break;
            case 4: // Tarea
            case 5: // Trabajo
            case 6: // Taller
            case 7: // Investigaci√≥n
            case 8: // Proyecto
            case 9: // Actividad Pr√°ctica
                mostrarAsignacionesModal = true;
                break;
            case 11: // Presentaci√≥n (Sliders)
            case 12: // Documento (Archivo)
            case 13: // Recurso de Lectura
            case 16: // Resumen de Clase (gu√≠a de clase)
                mostrarMaterialApoyoModal = true;
                break;
            case 14: // Clase Virtual
                mostrarClaseVirtualModal = true;
                break;
            case 17: // Evaluaci√≥n
                mostrarEvaluacionModal = true;
                break;
        }
        
        StateHasChanged();
    }
}
