@namespace ImpulsaDBA.Client.Components.Layout
@inherits LayoutComponentBase
@using Microsoft.AspNetCore.Components.Authorization
@using Blazored.LocalStorage
@using ImpulsaDBA.Client.Services
@using ImpulsaDBA.Client.Auth
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager Navigation
@inject ILocalStorageService LocalStorage
@inject AsignaturaService AsignaturaService

<div class="dashboard-container @(isCollapsed ? "sidebar-collapsed" : "")">
    <!-- Sidebar -->
    <aside class="dashboard-sidebar @(isCollapsed ? "collapsed" : "")">
        <div class="sidebar-header @(isCollapsed ? "sidebar-header-expandable" : "")" title="@(isCollapsed ? "Clic para expandir menú" : nombreInstitucion)" @onclick="() => { if (isCollapsed) ToggleSidebar(); }">
            <div class="sidebar-logo">
                @if (!string.IsNullOrWhiteSpace(logoInstitucionUrl))
                {
                    <img src="@logoInstitucionUrl" alt="Logo institución" class="sidebar-logo-img" />
                }
                else
                {
                    <div class="logo-icon">@(nombreInstitucion.Length > 0 ? nombreInstitucion[0].ToString().ToUpperInvariant() : "M")</div>
                }
            </div>
            <div class="sidebar-title">@FormatInstitutionName(nombreInstitucion)</div>
            <button class="sidebar-toggle" @onclick="ToggleSidebar" @onclick:stopPropagation="true" title="@(isCollapsed ? "Expandir" : "Colapsar")">
                <span class="toggle-icon">@(isCollapsed ? "→" : "←")</span>
            </button>
        </div>
        
        <nav class="sidebar-nav">
            <div class="sidebar-estudiante-wrap">
                <button type="button" class="sidebar-estudiante-trigger" @onclick="TogglePanelEstudiante" title="@(estudiantePanelOpen ? "Ocultar perfil" : "Ver mi perfil")">
                    <i class="bi bi-person-circle nav-icon"></i>
                    <span class="nav-text">Mi perfil</span>
                    <span class="nav-item-tooltip">Mi perfil</span>
                    <i class="bi @(estudiantePanelOpen ? "bi-chevron-up" : "bi-chevron-down") nav-chevron"></i>
                </button>

                @if (estudiantePanelOpen)
                {
                    <div class="sidebar-estudiante-panel">
                        <div class="sidebar-estudiante-avatar-wrap">
                            @if (TieneFotoPerfil())
                            {
                                <img src="@GetFotoPerfil()" alt="Foto" class="sidebar-estudiante-avatar" />
                            }
                            else
                            {
                                <div class="sidebar-estudiante-avatar-iniciales">@GetInicialesPerfil()</div>
                            }
                            <span class="sidebar-estudiante-led" title="En línea" aria-label="En línea"></span>
                        </div>

                        <div class="sidebar-estudiante-info">
                            <div class="sidebar-estudiante-name">@GetNombreCompletoPerfil()</div>
                            <div class="sidebar-estudiante-curso">Docente</div>
                        </div>
                    </div>
                }
            </div>
            <button class="nav-item @GetVistaActiveClass("inicio")" @onclick="@(() => MostrarVista("inicio"))">
                <i class="bi bi-house-fill nav-icon"></i>
                <span class="nav-text">Inicio</span>
            </button>
            <button class="nav-item @GetVistaActiveClass("asignaturas")" @onclick="@(() => MostrarVista("asignaturas"))">
                <i class="bi bi-book-fill nav-icon"></i>
                <span class="nav-text">Mis Asignaturas</span>
            </button>
            <button class="nav-item @GetVistaActiveClass("calendario")" @onclick="@(() => MostrarVista("calendario"))">
                <i class="bi bi-calendar3 nav-icon"></i>
                <span class="nav-text">Calendario</span>
            </button>
            @*<button class="nav-item @GetVistaActiveClass("calificar")" @onclick="@(() => MostrarVista("calificar"))">
                <i class="bi bi-clipboard-check nav-icon"></i>
                <span class="nav-text">Calificar actividades</span>
            </button>
            *@
            <button class="nav-item @GetVistaActiveClass("duplicar")" @onclick="@(() => MostrarVista("duplicar"))">
                <i class="bi bi-copy nav-icon"></i>
                <span class="nav-text">Duplicar actividades</span>
            </button>
            <a href="/dashboard/foro" class="nav-item @(EsRutaActivaForo() ? "active" : "")">
                <i class="bi bi-chat-dots nav-icon"></i>
                <span class="nav-text">Foro</span>
            </a>
        </nav>
        
        <div class="sidebar-footer">

            <button class="nav-item nav-logout" @onclick="Salir">
                <i class="bi bi-box-arrow-right nav-icon"></i>
                <span class="nav-text">Salir</span>
            </button>
        </div>
    </aside>

    <!-- Main Content Area -->
    <div class="dashboard-main">
        <!-- Header -->
        <header class="dashboard-header">
            <div class="header-left">
                <nav class="breadcrumb" aria-label="Migas de pan">
                    @{
                        var crumbs = GetBreadcrumbs();
                        var last = crumbs.Count - 1;
                    }
                    @for (var i = 0; i < crumbs.Count; i++)
                    {
                        var (label, path, _) = crumbs[i];
                        if (i > 0)
                        {
                            <span class="breadcrumb-sep" aria-hidden="true">/</span>
                        }
                        @if (i == last)
                        {
                            <span class="breadcrumb-current" aria-current="page">@label</span>
                        }
                        else
                        {
                            <a href="@path" class="breadcrumb-link">@label</a>
                        }
                    }
                </nav>
            </div>

            <div class="header-right">
                <button type="button" class="header-icon-btn" title="Notificaciones" aria-label="Notificaciones">
                    <i class="bi bi-bell-fill" aria-hidden="true"></i>
                    <span class="tooltip-text">Notificaciones</span>
                </button>
                <button type="button" class="header-icon-btn" title="Correo interno" aria-label="Correo interno">
                    <i class="bi bi-envelope-fill" aria-hidden="true"></i>
                    <span class="tooltip-text">Correo interno</span>
                </button>
            </div>
        </header>

        <!-- Content -->
        <main class="dashboard-content">
            <CascadingValue Value="vistaActual" Name="VistaActual">
                <CascadingValue Value="this" Name="DashboardLayout">
                    @Body
                </CascadingValue>
            </CascadingValue>
        </main>
    </div>
</div>

@code {
    private AuthenticationState? authState;
    private bool isCollapsed = true;
    private const string SIDEBAR_STATE_KEY = "sidebar_collapsed";
    /// <summary>Nombre de la institución. Se carga desde la base de datos en OnInitializedAsync (campo Institucion de las asignaturas del profesor).</summary>
    private string nombreInstitucion = "Instituto Los Libertadores";
    /// <summary>URL de la imagen/logo de la institución (ej: /images/logo-institucion.png). Si está vacío, se muestra la inicial del nombre.</summary>
    private string? logoInstitucionUrl = "https://www.ielibertadores.edu.co/sites/institucion-educativa-los-libertadores/content/files/000021/1005_escudo-iel_200x200.png"; // Asignar ej: "/images/logo-institucion.png" o desde configuración
    
    // Estado para controlar qué vista mostrar en el Dashboard
    private string vistaActual = "inicio"; // Vista por defecto según pendientes.md punto 2

    // Panel perfil docente (colapsable, igual que app estudiante)
    private bool estudiantePanelOpen = false;

    protected override void OnParametersSet()
    {
        // Actualizar vistaActual basado en la URL actual
        var uri = Navigation.ToAbsoluteUri(Navigation.Uri);
        var path = uri.AbsolutePath.ToLower();
        
        if (path.Contains("/inicio"))
            vistaActual = "inicio";
        else if (path.Contains("/asignaturas"))
            vistaActual = "asignaturas";
        else if (path.Contains("/calendario"))
            vistaActual = "calendario";
        else if (path.Contains("/calificar-actividades"))
            vistaActual = "calificar";
        else if (path.Contains("/duplicar-actividades"))
            vistaActual = "duplicar";
    }

    protected override async Task OnInitializedAsync()
    {
        authState = await AuthStateProvider.GetAuthenticationStateAsync();
        
        // Cargar estado del sidebar desde LocalStorage (por defecto: colapsado)
        try
        {
            var saved = await LocalStorage.GetItemAsync<string>(SIDEBAR_STATE_KEY);
            isCollapsed = saved != "false";
        }
        catch
        {
            isCollapsed = true;
        }

        // Obtener nombre de institución desde BD (usando las asignaturas asignadas al docente)
        try
        {
            var userIdClaim = authState?.User?.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;

            if (!string.IsNullOrEmpty(userIdClaim) && int.TryParse(userIdClaim, out int profesorId))
            {
                // Reutilizamos la misma lógica que alimenta las cards del dashboard
                var asignaturasProfesor = await AsignaturaService.ObtenerAsignaturasPorProfesor(profesorId);
                var primera = asignaturasProfesor.FirstOrDefault();
                if (primera is not null && !string.IsNullOrWhiteSpace(primera.Institucion))
                    nombreInstitucion = primera.Institucion;
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error al obtener nombre de institución: {ex.Message}");
        }
    }

    private void TogglePanelEstudiante()
    {
        estudiantePanelOpen = !estudiantePanelOpen;
        StateHasChanged();
    }

    private bool TieneFotoPerfil()
    {
        return !string.IsNullOrWhiteSpace(GetUserPhotoUrl());
    }

    private string GetFotoPerfil() => GetUserPhotoUrl();

    private string GetInicialesPerfil()
    {
        return GetUserInitials();
    }

    /// <summary>Nombre completo del docente (tal como viene del claim).</summary>
    private string GetNombreCompletoPerfil()
    {
        return authState?.User?.FindFirst(System.Security.Claims.ClaimTypes.Name)?.Value ?? "Usuario";
    }

    private async Task ToggleSidebar()
    {
        isCollapsed = !isCollapsed;
        // Guardar estado en LocalStorage
        try
        {
            await LocalStorage.SetItemAsync(SIDEBAR_STATE_KEY, isCollapsed ? "true" : "false");
        }
        catch
        {
            // Si hay error al guardar, continuar sin guardar
        }
        StateHasChanged();
    }


    /// <summary>
    /// Cambia la vista actual del Dashboard
    /// </summary>
    private void MostrarVista(string vista)
    {
        vistaActual = vista;
        
        // Navegar a la ruta correspondiente
        var ruta = vista switch
        {
            "inicio" => "/dashboard/inicio",
            "asignaturas" => "/dashboard/asignaturas",
            "calendario" => "/dashboard/calendario",
                "calificar" => "/dashboard/calificar-actividades",
            "duplicar" => "/dashboard/duplicar-actividades",
            _ => "/dashboard/inicio"
        };
        
        Navigation.NavigateTo(ruta, forceLoad: false);
        StateHasChanged();
    }
    
    /// <summary>
    /// Obtiene la clase activa para el botón del sidebar.
    /// Si estamos en la ruta del foro, ninguna de las vistas (inicio, asignaturas, etc.) debe verse activa.
    /// </summary>
    private string GetVistaActiveClass(string vista)
    {
        if (EsRutaActivaForo())
            return "";
        return vistaActual == vista ? "active" : "";
    }

    private bool EsRutaActivaForo()
    {
        var path = Navigation.ToAbsoluteUri(Navigation.Uri).AbsolutePath.TrimEnd('/');
        return path.StartsWith("/dashboard/foro", StringComparison.OrdinalIgnoreCase);
    }

    /// <summary>Genera las migajas de pan según la ruta actual.</summary>
    private List<(string Label, string Path, bool IsLast)> GetBreadcrumbs()
    {
        var uri = Navigation.ToAbsoluteUri(Navigation.Uri);
        var path = uri.AbsolutePath.TrimEnd('/');
        if (string.IsNullOrEmpty(path) || path == "/")
        {
            return new List<(string, string, bool)> { ("Dashboard", "/dashboard/inicio", true) };
        }

        var segments = path.Split('/', StringSplitOptions.RemoveEmptyEntries);
        if (segments.Length == 0)
        {
            return new List<(string, string, bool)> { ("Dashboard", "/dashboard/inicio", true) };
        }

        var result = new List<(string Label, string Path, bool IsLast)>();
        var acc = "";
        for (var i = 0; i < segments.Length; i++)
        {
            acc += "/" + segments[i];
            var segment = segments[i].ToLowerInvariant();
            var label = ObtenerEtiquetaRuta(segment, i > 0 ? segments[i - 1].ToLowerInvariant() : null);
            var pathForLink = acc;
            if (i == 0 && segment == "dashboard" && segments.Length > 1)
                pathForLink = "/dashboard/inicio";
            result.Add((label, pathForLink, i == segments.Length - 1));
        }
        return result;
    }

    private static string ObtenerEtiquetaRuta(string segment, string? segmentAnterior)
    {
        return segment switch
        {
            "dashboard" => "Dashboard",
            "inicio" => "Inicio",
            "calendario" => "Calendario",
            "asignaturas" => "Mis Asignaturas",
            "foro" => "Foro",
            "duplicar-actividades" => "Duplicar actividades",
            "calificar-actividades" => "Calificar actividades",
            "perfil" => "Mi perfil",
            _ => System.Globalization.CultureInfo.CurrentCulture.TextInfo.ToTitleCase(segment.Replace("-", " "))
        };
    }
    
    /// <summary>
    /// Método público para cambiar la vista desde componentes hijos
    /// </summary>
    public void CambiarVista(string vista)
    {
        vistaActual = vista;
        StateHasChanged();
    }

    private string GetUserName()
    {
        var fullName = authState?.User?.FindFirst(System.Security.Claims.ClaimTypes.Name)?.Value ?? "Usuario";
        
        if (string.IsNullOrEmpty(fullName) || fullName == "Usuario")
            return fullName;
        
        // Obtener primer apellido y primer nombre
        var parts = fullName.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        if (parts.Length >= 2)
        {
            // Si hay 2 partes: Nombre Apellido -> Apellido Nombre
            if (parts.Length == 2)
            {
                return $"{parts[1]} {parts[0]}";
            }
            // Si hay 3 o más partes: asumimos que el último es apellido y el primero es nombre
            // Ejemplo: "Juan Carlos Pérez" -> "Pérez Juan"
            else
            {
                return $"{parts[parts.Length - 1]} {parts[0]}";
            }
        }
        return parts[0];
    }

    private string GetUserRole()
    {
        var perfil = authState?.User?.FindFirst("Perfil")?.Value ?? "Usuario";
        // Mapear perfiles de la BD a nombres más amigables
        return perfil switch
        {
            "Docente" or "Profesor" => "Docente",
            "Estudiante" => "Estudiante",
            "Padre" or "Acudiente" => "Acudiente",
            _ => perfil
        };
    }

    private string GetUserInstitution()
    {
        return nombreInstitucion;
    }

    private static MarkupString FormatInstitutionName(string? name)
    {
        if (string.IsNullOrWhiteSpace(name))
            return new MarkupString("");

        var prefixes = new[]
        {
            "INSTITUCION EDUCATIVA",
            "INSTITUCIÓN EDUCATIVA",
            "COLEGIO",
            "ESCUELA"
        };

        var upper = name.ToUpperInvariant();

        foreach (var prefix in prefixes)
        {
            if (upper.StartsWith(prefix, StringComparison.OrdinalIgnoreCase) && name.Length >= prefix.Length)
            {
                var prefixDisplay = name.Substring(0, prefix.Length).Trim();
                var main = name.Substring(prefix.Length).Trim();
                var prefixEnc = System.Net.WebUtility.HtmlEncode(prefixDisplay);
                var mainEnc = System.Net.WebUtility.HtmlEncode(main);
                var html = $"<span class='sidebar-subtitle'>{prefixEnc}</span><span class='sidebar-main-title'>{mainEnc}</span>";
                return new MarkupString(html);
            }
        }

        var nameEnc = System.Net.WebUtility.HtmlEncode(name);
        return new MarkupString($"<span class='sidebar-main-title'>{nameEnc}</span>");
    }

    private string GetUserPhotoUrl()
    {
        return authState?.User?.FindFirst("FotoUrl")?.Value ?? string.Empty;
    }

    private string GetUserInitials()
    {
        var fullName = authState?.User?.FindFirst(System.Security.Claims.ClaimTypes.Name)?.Value ?? "Usuario";
        if (string.IsNullOrEmpty(fullName) || fullName == "Usuario") return "U";
        
        // Obtener solo el primer nombre y primer apellido para las iniciales
        var parts = fullName.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        if (parts.Length >= 2)
        {
            return $"{parts[0][0]}{parts[1][0]}".ToUpper();
        }
        return fullName[0].ToString().ToUpper();
    }

    private void GoBack()
    {
        Navigation.NavigateTo("/");
    }

    private async Task Salir()
    {
        try
        {
            // Resetear AuthState usando CustomAuthStateProvider
            if (AuthStateProvider is ImpulsaDBA.Client.Auth.CustomAuthStateProvider customProvider)
            {
                await customProvider.CerrarSesionAsync();
            }

            // Limpiar LocalStorage completamente
            await LocalStorage.ClearAsync();

            // Redireccionar a Login
            Navigation.NavigateTo("/login", true);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error al cerrar sesión: {ex.Message}");
            // Aún así redirigir al login
            Navigation.NavigateTo("/login", true);
        }
    }
}
