@using Microsoft.AspNetCore.Components.Web
@using Microsoft.JSInterop
@using ImpulsaDBA.Shared.DTOs
@using ImpulsaDBA.Client.Services
@using CurrieTechnologies.Razor.SweetAlert2
@inject SweetAlertService Swal
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime
@inject AyudaService AyudaService
@implements IAsyncDisposable

<div class="ayudas-dropdown-container" @ref="containerRef">
    <button class="ayudas-button" @onclick="ToggleDropdown">
        <span class="ayudas-icon-wrapper">
            <i class="bi bi-info"></i>
        </span>
        <i class="bi bi-chevron-down"></i>
    </button>
    
    @if (mostrarDropdown)
    {
        <div class="ayudas-dropdown">
            @{
                var tienePDF = PDF != null && !string.IsNullOrEmpty(PDF.UrlAyuda);
                var tieneVIDEO = VIDEO != null && !string.IsNullOrEmpty(VIDEO.UrlAyuda);
                
                Console.WriteLine($"üé® Renderizando dropdown:");
                Console.WriteLine($"   mostrarDropdown: {mostrarDropdown}");
                Console.WriteLine($"   PDF es null: {PDF == null}");
                Console.WriteLine($"   VIDEO es null: {VIDEO == null}");
                if (PDF != null)
                {
                    Console.WriteLine($"   PDF.UrlAyuda: '{PDF.UrlAyuda}'");
                    Console.WriteLine($"   PDF.UrlAyuda es null o vac√≠o: {string.IsNullOrEmpty(PDF.UrlAyuda)}");
                }
                if (VIDEO != null)
                {
                    Console.WriteLine($"   VIDEO.UrlAyuda: '{VIDEO.UrlAyuda}'");
                    Console.WriteLine($"   VIDEO.UrlAyuda es null o vac√≠o: {string.IsNullOrEmpty(VIDEO.UrlAyuda)}");
                }
                Console.WriteLine($"   tienePDF: {tienePDF}");
                Console.WriteLine($"   tieneVIDEO: {tieneVIDEO}");
            }
            
            @if (tienePDF)
            {
                <a href="@PDF!.UrlAyuda" target="_blank" class="ayudas-dropdown-item" @onclick="() => OnItemClick(PDF.UrlAyuda)">
                    PDF
                </a>
            }
            @if (tieneVIDEO)
            {
                <a href="@VIDEO!.UrlAyuda" target="_blank" class="ayudas-dropdown-item" @onclick="() => OnItemClick(VIDEO.UrlAyuda)">
                    Video
                </a>
            }
            @if (!tienePDF && !tieneVIDEO)
            {
                <div class="ayudas-dropdown-item ayudas-dropdown-item-disabled">
                    No hay ayudas disponibles
                </div>
            }
        </div>
    }
</div>

@code
{
    [Parameter] public int IdComponente { get; set; } = 101; // Por defecto: inicio (101=VIDEO, 102=PDF)
    
    private ElementReference containerRef;
    private DotNetObjectReference<Ayudas>? objRef;
    
    private AyudaDto? PDF { get; set; }
    private AyudaDto? VIDEO { get; set; }
    private bool mostrarDropdown = false;

    protected override async Task OnInitializedAsync()
    {
        await CargarAyudas();
    }

    protected override async Task OnParametersSetAsync()
    {
        // Recargar ayudas cuando cambie el IdComponente
        await CargarAyudas();
    }

    private async Task CargarAyudas()
    {
        try
        {
            Console.WriteLine($"üìñ Componente Ayudas - Cargando ayudas para componente: {IdComponente}");
            // Obtener ayudas desde la API seg√∫n el componente
            // 101 = VIDEO inicio, 102 = PDF inicio
            // 103 = VIDEO asignaturas, 104 = PDF asignaturas
            // 105 = VIDEO calendario, 106 = PDF calendario
            var (pdf, video) = await AyudaService.ObtenerAyudasPorComponente(IdComponente);
            
            PDF = pdf;
            VIDEO = video;
            
            Console.WriteLine($"üìñ Componente Ayudas - Resultado despu√©s de asignar:");
            Console.WriteLine($"   PDF: {(PDF != null ? $"S√≠ (Id: {PDF.Id}, URL: {PDF.UrlAyuda})" : "No")}");
            Console.WriteLine($"   VIDEO: {(VIDEO != null ? $"S√≠ (Id: {VIDEO.Id}, URL: {VIDEO.UrlAyuda})" : "No")}");
            
            // Verificar valores espec√≠ficos
            if (PDF != null)
            {
                Console.WriteLine($"   PDF.UrlAyuda es null o vac√≠o: {string.IsNullOrEmpty(PDF.UrlAyuda)}");
            }
            if (VIDEO != null)
            {
                Console.WriteLine($"   VIDEO.UrlAyuda es null o vac√≠o: {string.IsNullOrEmpty(VIDEO.UrlAyuda)}");
            }
            
            // Forzar actualizaci√≥n de la UI
            await InvokeAsync(StateHasChanged);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"‚ùå Componente Ayudas - Error al cargar ayudas: {ex.Message}");
            Console.WriteLine($"‚ùå Componente Ayudas - Stack trace: {ex.StackTrace}");
            PDF = null;
            VIDEO = null;
            await InvokeAsync(StateHasChanged);
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (mostrarDropdown)
        {
            objRef = DotNetObjectReference.Create(this);
            await JSRuntime.InvokeVoidAsync("setupAyudasDropdown", containerRef, objRef);
        }
        else if (!mostrarDropdown && objRef != null)
        {
            await JSRuntime.InvokeVoidAsync("removeAyudasDropdown", containerRef);
        }
    }

    [JSInvokable]
    public void CloseDropdown()
    {
        mostrarDropdown = false;
        InvokeAsync(StateHasChanged);
    }

    private async Task ToggleDropdown()
    {
        // Si se est√° abriendo el dropdown, recargar las ayudas primero
        if (!mostrarDropdown)
        {
            Console.WriteLine($"üîÑ Abriendo dropdown - Recargando ayudas para componente: {IdComponente}");
            await CargarAyudas();
            // Esperar un momento para que los datos se asignen y el renderizado se complete
            await Task.Delay(50);
        }
        
        mostrarDropdown = !mostrarDropdown;
        
        if (!mostrarDropdown && objRef != null)
        {
            await JSRuntime.InvokeVoidAsync("removeAyudasDropdown", containerRef);
        }
        
        Console.WriteLine($"üîÑ ToggleDropdown - mostrarDropdown: {mostrarDropdown}");
        Console.WriteLine($"   PDF: {(PDF != null ? $"S√≠ (URL: {PDF.UrlAyuda})" : "No")}");
        Console.WriteLine($"   VIDEO: {(VIDEO != null ? $"S√≠ (URL: {VIDEO.UrlAyuda})" : "No")}");
        
        await InvokeAsync(StateHasChanged);
    }

    private void OnItemClick(string url)
    {
        mostrarDropdown = false;
        // La navegaci√≥n se maneja con el href del enlace
    }

    public async ValueTask DisposeAsync()
    {
        if (objRef != null)
        {
            try
            {
                await JSRuntime.InvokeVoidAsync("removeAyudasDropdown", containerRef);
            }
            catch { }
            objRef.Dispose();
        }
    }
}

<style>
    .ayudas-dropdown-container {
        position: relative;
        display: inline-block;
    }

    .ayudas-button {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        background-color: #006bb7;
        border: none;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: background-color 0.2s ease;
        position: relative;
        gap: 4px;
        padding: 0;
    }

    .ayudas-button:hover {
        background-color: #005a9e;
    }

    .ayudas-icon-wrapper {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 1.25rem;
        height: 1.25rem;
        background-color: #006bb7;
        border-radius: 50%;
        position: relative;
    }
    
    .ayudas-icon-wrapper i {
        font-size: 0.85rem;
        color: white;
        line-height: 1;
        font-weight: bold;
    }
    
    .ayudas-button i:last-child {
        font-size: 0.85rem;
        margin-left: 2px;
        color: white;
    }

    .ayudas-button i:last-child {
        font-size: 0.75rem;
        margin-left: 2px;
        color: #ffffff;
    }

    .ayudas-dropdown {
        position: absolute;
        top: calc(100% + 8px);
        right: 0;
        background: white;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        min-width: 120px;
        z-index: 1000;
        overflow: hidden;
        border: 1px solid #e0e0e0;
    }

    .ayudas-dropdown-item {
        display: block;
        padding: 12px 16px;
        color: #333;
        text-decoration: none;
        cursor: pointer;
        transition: background-color 0.15s ease;
        border: none;
        background: none;
        width: 100%;
        text-align: left;
    }

    .ayudas-dropdown-item:hover {
        background-color: #f5f5f5;
    }

    .ayudas-dropdown-item-disabled {
        color: #999;
        cursor: not-allowed;
    }

    .ayudas-dropdown-item-disabled:hover {
        background-color: transparent;
    }
</style>
    