@page "/dashboard/calendario"
@layout DashboardLayout
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.WebUtilities
@using ImpulsaDBA.Models
@using ImpulsaDBA.Components.Shared
@using ImpulsaDBA.Components.Pages.CreacionActividades
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager Navigation
@inject AsignaturaService AsignaturaService
@inject CalendarioService CalendarioService
@attribute [Microsoft.AspNetCore.Authorization.Authorize]

<PageTitle>Calendario - ImpulsaDBA</PageTitle>

<div class="calendario-page">
    @if (isLoading)
    {
        <div class="loading-container">
            <div class="spinner"></div>
            <p>Cargando calendario...</p>
        </div>
    }
    else
    {
        <div class="page-header">
            <div class="page-header-left">
                <h1>Calendario Académico</h1>
                <div class="filtros-container">
                    <div class="filtro-item">
                        <label for="select-grupo">Filtrar por grupo:</label>
                        <select id="select-grupo" class="select-filtro" @onchange="OnGrupoChange">
                            <option value="0">Todos los grupos</option>
                            @foreach (var grupo in gruposDisponibles)
                            {
                                <option value="@grupo.GrupoId" selected="@(grupoSeleccionado?.GrupoId == grupo.GrupoId)">
                                    @grupo.NombreGrupo
                                </option>
                            }
                        </select>
                    </div>
                    <div class="filtro-item">
                        <label for="select-asignatura">Filtrar por asignatura:</label>
                        <select id="select-asignatura" class="select-filtro" @onchange="OnAsignaturaChange">
                            <option value="0">Todas las asignaturas</option>
                            @foreach (var asignatura in asignaturasFiltradas)
                            {
                                <option value="@asignatura.IdAsignacionAcademica" selected="@(asignaturaSeleccionada?.IdAsignacionAcademica == asignatura.IdAsignacionAcademica)">
                                    @asignatura.Nombre - @asignatura.Grupo
                                </option>
                            }
                        </select>
                    </div>
                </div>
            </div>
            <div class="page-header-right">
                <Ayudas />
            </div>
        </div>

        <div class="calendario-wrapper">
            <CalendarioComponent IdAsignacionAcademica="@idAsignacionAcademicaActual" 
                                OnDiaSeleccionado="OnDiaClick"
                                OnActividadSeleccionada="OnActividadClick"
                                @ref="calendarioComponentRef" />
        </div>
    }
</div>

<ModalActividad Mostrar="@mostrarModal" 
                FechaSeleccionada="@fechaSeleccionadaModal"
                OnTipoSeleccionado="OnTipoActividadSeleccionado"
                OnCerrar="CerrarModal" />

<!-- Modales específicos de creación -->
<!-- Modal 1: Video de Enganche -->
<VideoDeEnganche Mostrar="@mostrarVideoEngancheModal"
                 FechaSeleccionada="@fechaSeleccionadaModal"
                 IdAsignacionAcademica="@idAsignacionAcademicaActual"
                 ActividadEditar="@(actividadEditando?.IdTipoActividad == 1 ? actividadEditando : null)"
                 OnCerrar="CerrarVideoEngancheModal"
                 OnActividadGuardada="RecargarCalendarioDespuesGuardar" />

<!-- Modal 2: Preguntas Problematizadoras -->
<PreguntasProblematizadoras Mostrar="@mostrarPreguntasModal"
                            FechaSeleccionada="@fechaSeleccionadaModal"
                            IdAsignacionAcademica="@idAsignacionAcademicaActual"
                            ActividadEditar="@(actividadEditando?.IdTipoActividad == 2 ? actividadEditando : null)"
                            OnCerrar="CerrarPreguntasModal"
                            OnActividadGuardada="RecargarCalendarioDespuesGuardar" />

<!-- Modal 3: Recurso Interactivo (Lección Interactiva / Juego Educativo) -->
<RecursoInteractivo Mostrar="@mostrarRecursoInteractivoModal"
                    FechaSeleccionada="@fechaSeleccionadaModal"
                    IdAsignacionAcademica="@idAsignacionAcademicaActual"
                    TipoActividadId="@tipoActividadSeleccionadoId"
                    ActividadEditar="@(actividadEditando != null && (actividadEditando.IdTipoActividad == 3 || actividadEditando.IdTipoActividad == 10) ? actividadEditando : null)"
                    OnCerrar="CerrarRecursoInteractivoModal"
                    OnActividadGuardada="RecargarCalendarioDespuesGuardar" />

<!-- Modal 4: Asignaciones (Tarea, Trabajo, Taller, Investigación, Proyecto, Actividad Práctica) -->
<Asignaciones Mostrar="@mostrarAsignacionesModal"
              FechaSeleccionada="@fechaSeleccionadaModal"
              IdAsignacionAcademica="@idAsignacionAcademicaActual"
              TipoActividadId="@tipoActividadSeleccionadoId"
              ActividadEditar="@(actividadEditando != null && (actividadEditando.IdTipoActividad >= 4 && actividadEditando.IdTipoActividad <= 9) ? actividadEditando : null)"
              OnCerrar="CerrarAsignacionesModal"
              OnActividadGuardada="RecargarCalendarioDespuesGuardar" />

<!-- Modal 5: Material de Apoyo (Presentación, Documento, Recurso de Lectura, Resumen de Clase) -->
<MaterialApoyo Mostrar="@mostrarMaterialApoyoModal"
               FechaSeleccionada="@fechaSeleccionadaModal"
               IdAsignacionAcademica="@idAsignacionAcademicaActual"
               TipoActividadId="@tipoActividadSeleccionadoId"
               ActividadEditar="@(actividadEditando != null && (actividadEditando.IdTipoActividad == 11 || actividadEditando.IdTipoActividad == 12 || actividadEditando.IdTipoActividad == 13 || actividadEditando.IdTipoActividad == 16) ? actividadEditando : null)"
               OnCerrar="CerrarMaterialApoyoModal"
               OnActividadGuardada="RecargarCalendarioDespuesGuardar" />

<!-- Modal 6: Clase Virtual -->
<ClaseVirtual Mostrar="@mostrarClaseVirtualModal"
              FechaSeleccionada="@fechaSeleccionadaModal"
              IdAsignacionAcademica="@idAsignacionAcademicaActual"
              ActividadEditar="@(actividadEditando?.IdTipoActividad == 14 ? actividadEditando : null)"
              OnCerrar="CerrarClaseVirtualModal"
              OnActividadGuardada="RecargarCalendarioDespuesGuardar" />

<style>
    .calendario-page {
        max-width: 1400px;
        margin: 0 auto;
    }

    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 2rem;
        gap: 1rem;
    }

    .page-header-left {
        flex: 1;
    }

    .page-header-right {
        display: flex;
        align-items: center;
    }

    .page-header h1 {
        font-size: 2rem;
        font-weight: 600;
        color: var(--color-text-primary);
        margin-bottom: 1rem;
    }

    .filtros-container {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 1.5rem;
        margin-top: 1rem;
    }

    .filtro-item {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .filtros-container label {
        font-weight: 500;
        color: var(--color-text-primary);
        font-size: 0.9rem;
    }

    .select-filtro {
        padding: 0.5rem 1rem;
        border: 1px solid var(--color-border);
        border-radius: var(--border-radius-md);
        background-color: var(--color-bg-primary);
        color: var(--color-text-primary);
        font-size: 0.95rem;
        cursor: pointer;
        min-width: 250px;
    }

    .select-filtro:focus {
        outline: none;
        border-color: var(--color-primary);
    }

    .calendario-wrapper {
        margin-top: 2rem;
    }

    .loading-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 400px;
        gap: 1rem;
    }

    .spinner {
        width: 40px;
        height: 40px;
        border: 4px solid var(--color-border);
        border-top-color: var(--color-primary);
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @@keyframes spin {
        to { transform: rotate(360deg); }
    }

    @@media (max-width: 768px) {
        .page-header {
            flex-direction: column;
            align-items: stretch;
        }

        .page-header-right {
            align-self: flex-end;
            margin-top: 1rem;
        }

        .filtros-container {
            flex-direction: column;
            align-items: stretch;
            gap: 1rem;
        }

        .filtro-item {
            width: 100%;
        }

        .select-filtro {
            width: 100%;
            min-width: auto;
        }
    }
</style>

@code {
    private CalendarioComponent? calendarioComponentRef;
    private List<Asignatura> asignaturas = new();
    private List<Asignatura> asignaturasFiltradas = new();
    private Asignatura? asignaturaSeleccionada;
    
    // Modelo para grupos únicos
    private class GrupoInfo
    {
        public int GrupoId { get; set; }
        public string NombreGrupo { get; set; } = string.Empty;
    }
    
    private List<GrupoInfo> gruposDisponibles = new();
    private GrupoInfo? grupoSeleccionado;
    
    private int idAsignacionAcademicaActual = 0;
    private bool isLoading = true;
    private bool mostrarModal = false;
    private DateTime fechaSeleccionadaModal = DateTime.Today;
    
    // Modales específicos
    private bool mostrarVideoEngancheModal = false;
    private bool mostrarPreguntasModal = false;
    private bool mostrarRecursoInteractivoModal = false;
    private bool mostrarAsignacionesModal = false;
    private bool mostrarMaterialApoyoModal = false;
    private bool mostrarClaseVirtualModal = false;
    private int tipoActividadSeleccionadoId = 0;
    private ActividadCalendario? actividadEditando = null;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var userIdClaim = authState?.User?.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;

            if (!string.IsNullOrEmpty(userIdClaim) && int.TryParse(userIdClaim, out int profesorId))
            {
                asignaturas = await AsignaturaService.ObtenerAsignaturasPorProfesor(profesorId);
                
                // Obtener grupos únicos de las asignaturas
                gruposDisponibles = asignaturas
                    .GroupBy(a => new { a.GrupoId, a.Grupo })
                    .Select(g => new GrupoInfo
                    {
                        GrupoId = g.Key.GrupoId,
                        NombreGrupo = g.Key.Grupo
                    })
                    .OrderBy(g => g.NombreGrupo)
                    .ToList();
                
                // Inicializar asignaturas filtradas con todas las asignaturas
                asignaturasFiltradas = asignaturas.ToList();
                
                // Obtener asignaturaId de query string si existe
                var uri = Navigation.ToAbsoluteUri(Navigation.Uri);
                if (Microsoft.AspNetCore.WebUtilities.QueryHelpers.ParseQuery(uri.Query).TryGetValue("asignaturaId", out var asignaturaIdStr))
                {
                    if (int.TryParse(asignaturaIdStr, out int asignaturaId))
                    {
                        asignaturaSeleccionada = asignaturas.FirstOrDefault(a => a.Id == asignaturaId);
                        if (asignaturaSeleccionada != null)
                        {
                            idAsignacionAcademicaActual = asignaturaSeleccionada.IdAsignacionAcademica;
                            // Seleccionar el grupo correspondiente
                            grupoSeleccionado = gruposDisponibles.FirstOrDefault(g => g.GrupoId == asignaturaSeleccionada.GrupoId);
                        }
                    }
                }
                else if (asignaturas.Count > 0)
                {
                    // Si no hay asignatura en query, usar la primera
                    asignaturaSeleccionada = asignaturas.First();
                    idAsignacionAcademicaActual = asignaturaSeleccionada.IdAsignacionAcademica;
                    grupoSeleccionado = gruposDisponibles.FirstOrDefault(g => g.GrupoId == asignaturaSeleccionada.GrupoId);
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error al cargar calendario: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private void OnGrupoChange(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out int grupoId))
        {
            if (grupoId == 0)
            {
                grupoSeleccionado = null;
                asignaturasFiltradas = asignaturas.ToList();
            }
            else
            {
                grupoSeleccionado = gruposDisponibles.FirstOrDefault(g => g.GrupoId == grupoId);
                asignaturasFiltradas = asignaturas.Where(a => a.GrupoId == grupoId).ToList();
            }
            
            // Si la asignatura seleccionada no está en el grupo filtrado, limpiar selección
            if (asignaturaSeleccionada != null && !asignaturasFiltradas.Any(a => a.IdAsignacionAcademica == asignaturaSeleccionada.IdAsignacionAcademica))
            {
                asignaturaSeleccionada = null;
                idAsignacionAcademicaActual = 0;
            }
            // Si hay asignaturas filtradas y no hay selección, seleccionar la primera
            else if (asignaturaSeleccionada == null && asignaturasFiltradas.Count > 0)
            {
                asignaturaSeleccionada = asignaturasFiltradas.First();
                idAsignacionAcademicaActual = asignaturaSeleccionada.IdAsignacionAcademica;
            }
            
            StateHasChanged();
        }
    }

    private void OnAsignaturaChange(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out int idAsignacion))
        {
            if (idAsignacion == 0)
            {
                asignaturaSeleccionada = null;
                idAsignacionAcademicaActual = 0;
            }
            else
            {
                asignaturaSeleccionada = asignaturasFiltradas.FirstOrDefault(a => a.IdAsignacionAcademica == idAsignacion);
                if (asignaturaSeleccionada != null)
                {
                    idAsignacionAcademicaActual = idAsignacion;
                    // Actualizar grupo seleccionado según la asignatura
                    grupoSeleccionado = gruposDisponibles.FirstOrDefault(g => g.GrupoId == asignaturaSeleccionada.GrupoId);
                }
            }
            StateHasChanged();
        }
    }

    private async Task OnDiaClick(DateTime fecha)
    {
        fechaSeleccionadaModal = fecha;
        mostrarModal = true;
        StateHasChanged();
    }

    private async Task OnTipoActividadSeleccionado(TipoActividad tipo)
    {
        tipoActividadSeleccionadoId = tipo.Id;
        
        // Cerrar el modal principal
        await CerrarModal();
        
        // Abrir el modal específico según el tipo (IDs de tab.tipo_recurso)
        switch (tipo.Id)
        {
            case 1: // Modal 1: Video de Enganche
                mostrarVideoEngancheModal = true;
                break;
            case 2: // Modal 2: Preguntas problematizadoras
                mostrarPreguntasModal = true;
                break;
            case 3: // Modal 3: Lección Interactiva
            case 10: // Modal 3: Juego Educativo
                mostrarRecursoInteractivoModal = true;
                break;
            case 4: // Modal 4: Tarea
            case 5: // Modal 4: Trabajo
            case 6: // Modal 4: Taller
            case 7: // Modal 4: Investigación
            case 8: // Modal 4: Proyecto
            case 9: // Modal 4: Actividad Práctica
                mostrarAsignacionesModal = true;
                break;
            case 11: // Modal 5: Presentación (Sliders)
            case 12: // Modal 5: Documento (Archivo)
            case 13: // Modal 5: Recurso de Lectura
            case 16: // Modal 5: Resumen de Clase (guía de clase)
                mostrarMaterialApoyoModal = true;
                break;
            case 14: // Modal 6: Clase Virtual
                mostrarClaseVirtualModal = true;
                break;
            default:
                // Para otros tipos, por ahora solo mostrar mensaje
                Console.WriteLine($"Tipo seleccionado: {tipo.Nombre} (ID: {tipo.Id}) para fecha: {fechaSeleccionadaModal:yyyy-MM-dd}");
                break;
        }
        
        StateHasChanged();
    }
    
    private async Task CerrarVideoEngancheModal()
    {
        mostrarVideoEngancheModal = false;
        actividadEditando = null;
        StateHasChanged();
    }
    
    private async Task CerrarPreguntasModal()
    {
        mostrarPreguntasModal = false;
        actividadEditando = null;
        StateHasChanged();
    }
    
    private async Task CerrarRecursoInteractivoModal()
    {
        mostrarRecursoInteractivoModal = false;
        tipoActividadSeleccionadoId = 0;
        actividadEditando = null;
        StateHasChanged();
    }
    
    private async Task CerrarAsignacionesModal()
    {
        mostrarAsignacionesModal = false;
        tipoActividadSeleccionadoId = 0;
        actividadEditando = null;
        StateHasChanged();
    }
    
    private async Task CerrarMaterialApoyoModal()
    {
        mostrarMaterialApoyoModal = false;
        tipoActividadSeleccionadoId = 0;
        actividadEditando = null;
        StateHasChanged();
    }
    
    private async Task CerrarClaseVirtualModal()
    {
        mostrarClaseVirtualModal = false;
        actividadEditando = null;
        StateHasChanged();
    }

    private async Task CerrarModal()
    {
        mostrarModal = false;
        StateHasChanged();
    }

    private async Task RecargarCalendarioDespuesGuardar()
    {
        if (calendarioComponentRef != null)
        {
            await calendarioComponentRef.RecargarCalendario();
        }
        actividadEditando = null;
    }

    private async Task OnActividadClick(ActividadCalendario actividad)
    {
        actividadEditando = actividad;
        tipoActividadSeleccionadoId = actividad.IdTipoActividad;
        fechaSeleccionadaModal = actividad.FechaInicio;

        // Abrir el modal correspondiente según el tipo de actividad
        switch (actividad.IdTipoActividad)
        {
            case 1: // Video de Enganche
                mostrarVideoEngancheModal = true;
                break;
            case 2: // Preguntas problematizadoras
                mostrarPreguntasModal = true;
                break;
            case 3: // Lección Interactiva
            case 10: // Juego Educativo
                mostrarRecursoInteractivoModal = true;
                break;
            case 4: // Tarea
            case 5: // Trabajo
            case 6: // Taller
            case 7: // Investigación
            case 8: // Proyecto
            case 9: // Actividad Práctica
                mostrarAsignacionesModal = true;
                break;
            case 11: // Presentación (Sliders)
            case 12: // Documento (Archivo)
            case 13: // Recurso de Lectura
            case 16: // Resumen de Clase (guía de clase)
                mostrarMaterialApoyoModal = true;
                break;
            case 14: // Clase Virtual
                mostrarClaseVirtualModal = true;
                break;
        }
        
        StateHasChanged();
    }
}
